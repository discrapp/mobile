---
name: E2E Tests

on:
  # Run on push to main after PRs are merged
  push:
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      flow:
        description: 'Specific flow to run (leave empty for all)'
        required: false
        default: ''
      skip_cache:
        description: 'Skip build cache (force rebuild)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

jobs:
  e2e:
    name: Maestro E2E Tests
    runs-on: macos-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          maestro --version

      - name: Start iOS Simulator
        id: simulator
        run: |
          # List available simulators and find the first iPhone
          DEVICE_LINE=$(xcrun simctl list devices available | grep -E "iPhone [0-9]+" | head -1)
          echo "Found device line: $DEVICE_LINE"

          # Extract UDID - it's the UUID pattern in parentheses
          SIMULATOR_UDID=$(echo "$DEVICE_LINE" | grep -oE '[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}')
          SIMULATOR_NAME=$(echo "$DEVICE_LINE" | sed 's/^[[:space:]]*//' | cut -d'(' -f1 | xargs)

          echo "Booting simulator: $SIMULATOR_NAME ($SIMULATOR_UDID)"
          xcrun simctl boot "$SIMULATOR_UDID" || true
          echo "udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT
          echo "name=$SIMULATOR_NAME" >> $GITHUB_OUTPUT
          # Wait for simulator to be ready
          sleep 10

      # Cache 1: Expo prebuild (ios/ folder with native code)
      - name: Generate prebuild cache key
        id: prebuild-key
        run: |
          # Hash files that affect native code generation
          HASH=$(cat package-lock.json app.json | shasum -a 256 | cut -d' ' -f1)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Restore Expo prebuild cache
        id: prebuild-cache
        if: ${{ github.event.inputs.skip_cache != 'true' }}
        uses: actions/cache/restore@v4
        with:
          path: ios
          key: expo-prebuild-${{ steps.prebuild-key.outputs.hash }}

      - name: Run Expo prebuild
        if: steps.prebuild-cache.outputs.cache-hit != 'true'
        run: npx expo prebuild --platform ios --clean

      - name: Save Expo prebuild cache
        if: steps.prebuild-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ios
          key: expo-prebuild-${{ steps.prebuild-key.outputs.hash }}

      # Cache 2: Compiled .app bundle
      - name: Generate build cache key
        id: build-key
        run: |
          # Hash files that affect the final build
          # Include ios/ folder state, source files, and env vars
          FILES_HASH=$(find ios -type f -name "*.swift" -o -name "*.m" -o -name "*.h" -o -name "Podfile.lock" 2>/dev/null | sort | xargs cat 2>/dev/null | shasum -a 256 | cut -d' ' -f1 || echo "no-ios")
          SRC_HASH=$(find app components lib -type f -name "*.ts" -o -name "*.tsx" 2>/dev/null | sort | xargs cat 2>/dev/null | shasum -a 256 | cut -d' ' -f1)
          echo "hash=${FILES_HASH:0:16}-${SRC_HASH:0:16}" >> $GITHUB_OUTPUT

      - name: Restore build cache
        id: build-cache
        if: ${{ github.event.inputs.skip_cache != 'true' }}
        uses: actions/cache/restore@v4
        with:
          path: ios/build/Build/Products/Release-iphonesimulator
          key: ios-build-${{ steps.build-key.outputs.hash }}

      - name: Install Pods
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: |
          cd ios
          pod install

      - name: Build iOS app
        if: steps.build-cache.outputs.cache-hit != 'true'
        run: |
          cd ios
          # Build for simulator without code signing
          xcodebuild \
            -workspace Discr.xcworkspace \
            -scheme Discr \
            -configuration Release \
            -sdk iphonesimulator \
            -destination "id=${{ steps.simulator.outputs.udid }}" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            -derivedDataPath build \
            build
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Save build cache
        if: steps.build-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ios/build/Build/Products/Release-iphonesimulator
          key: ios-build-${{ steps.build-key.outputs.hash }}

      - name: Install app on simulator
        run: |
          # Find and install the .app
          APP_PATH=$(find ios/build/Build/Products/Release-iphonesimulator -name "*.app" -type d | head -1)
          echo "Installing app: $APP_PATH"
          xcrun simctl install "${{ steps.simulator.outputs.udid }}" "$APP_PATH"
          # Launch the app
          BUNDLE_ID=$(defaults read "$APP_PATH/Info.plist" CFBundleIdentifier)
          echo "Launching app: $BUNDLE_ID"
          xcrun simctl launch "${{ steps.simulator.outputs.udid }}" "$BUNDLE_ID"

      - name: Run E2E Tests
        run: |
          if [ -n "${{ github.event.inputs.flow }}" ]; then
            maestro test "${{ github.event.inputs.flow }}"
          else
            maestro test .maestro/
          fi
        env:
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-artifacts
          path: |
            ~/.maestro/tests/
            ~/Library/Logs/DiagnosticReports/
          retention-days: 7
