---
name: E2E Tests

on:
  # Run on push to main after PRs are merged
  push:
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      flow:
        description: 'Specific flow to run (leave empty for all)'
        required: false
        default: ''

permissions:
  contents: read

jobs:
  e2e:
    name: Maestro E2E Tests
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$PATH:$HOME/.maestro/bin"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          maestro --version

      - name: Start iOS Simulator
        id: simulator
        run: |
          # List available simulators and find the first iPhone
          # The format is: "    iPhone 15 Pro (UDID) (Shutdown)"
          # We need to extract the UDID (first parenthesized value, which is a UUID)
          DEVICE_LINE=$(xcrun simctl list devices available | grep -E "iPhone [0-9]+" | head -1)
          echo "Found device line: $DEVICE_LINE"

          # Extract UDID - it's the UUID pattern in parentheses
          SIMULATOR_UDID=$(echo "$DEVICE_LINE" | grep -oE '[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}')
          SIMULATOR_NAME=$(echo "$DEVICE_LINE" | sed 's/^[[:space:]]*//' | cut -d'(' -f1 | xargs)

          echo "Booting simulator: $SIMULATOR_NAME ($SIMULATOR_UDID)"
          xcrun simctl boot "$SIMULATOR_UDID" || true
          echo "udid=$SIMULATOR_UDID" >> $GITHUB_OUTPUT
          echo "name=$SIMULATOR_NAME" >> $GITHUB_OUTPUT
          # Wait for simulator to be ready
          sleep 10

      - name: Build and install app
        run: |
          # Build for the booted simulator (avoids code signing requirements)
          npx expo run:ios --device "${{ steps.simulator.outputs.udid }}" --configuration Release
        env:
          EXPO_PUBLIC_SUPABASE_URL: ${{ secrets.EXPO_PUBLIC_SUPABASE_URL }}
          EXPO_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.EXPO_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Run E2E Tests
        run: |
          if [ -n "${{ github.event.inputs.flow }}" ]; then
            maestro test "${{ github.event.inputs.flow }}"
          else
            maestro test .maestro/
          fi
        env:
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-artifacts
          path: |
            ~/.maestro/tests/
            ~/Library/Logs/DiagnosticReports/
          retention-days: 7

  # Alternative: Run on Maestro Cloud (faster, parallel, but requires subscription)
  # e2e-cloud:
  #   name: Maestro Cloud E2E
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: mobile-dev-inc/action-maestro-cloud@v1
  #       with:
  #         api-key: ${{ secrets.MAESTRO_CLOUD_API_KEY }}
  #         app-file: path/to/app.ipa
